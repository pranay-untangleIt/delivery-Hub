/**
 * @description Test class for DeliveryHubSettingsController.
 * Verifies DTO mapping, saving of settings, and mock API callouts.
 */
@isTest
private class DeliveryHubSettingsControllerTest {
    
    @testSetup
    static void setupTestData() {
        Delivery_Hub_Settings__c settings = new Delivery_Hub_Settings__c(
            SetupOwnerId = UserInfo.getOrganizationId(),
            EnableNotificationsBool__c = true,
            AutoCreateRequestFromTicketBool__c = true, // NEW Field
            AutoSyncNetworkEntityBool__c = true,       // Maps to AutoSend
            AISuggestionsEnabledBool__c = true,
            AutoGenerateDescriptionsBool__c = true,
            AIEstimationEnabledBool__c = true,
            OpenAIApiKeyTxt__c = 'test-key',
            OpenAIModelTxt__c = 'gpt-4o',
            JIRAEnabledBool__c = true,
            JIRAInstanceUrl__c = 'https://example.atlassian.net',
            JIRAUsernameTxt__c = 'jirauser@example.com',
            JIRAApiTokenTxt__c = 'test-token',
            JIRAProjectKeyTxt__c = 'ABC',
            JIraApiTestedBool__c = true,
            OpenAiApiTestedBool__c = true
        );
        insert settings;
    }

    @isTest
    static void testGetSettings() {
        Test.startTest();
        DeliveryHubSettingsController.SettingsDTO dto = DeliveryHubSettingsController.getSettings();
        Test.stopTest();

        System.assertNotEquals(null, dto, 'Settings DTO should not be null');
        System.assertEquals(true, dto.enableNotifications, 'Notifications should be enabled');
        
        // FIX: Check the new DTO field names
        System.assertEquals(true, dto.autoCreateRequest, 'Auto Create Request should be true');
        System.assertEquals(true, dto.autoSendRequest, 'Auto Send Request should be true');
        
        System.assert(dto.aiSuggestionsEnabled, 'AI Suggestions should be true');
        System.assertEquals('gpt-4o', dto.openaiModel, 'OpenAI model should be gpt-4o');
    }

    @isTest
    static void testSaveGeneralSettings() {
        Test.startTest();
        // FIX: Pass 3 arguments: (Notifications, AutoCreate, AutoSend)
        DeliveryHubSettingsController.saveGeneralSettings(false, false, false);
        Test.stopTest();

        Delivery_Hub_Settings__c s = Delivery_Hub_Settings__c.getOrgDefaults();
        
        System.assertEquals(false, s.EnableNotificationsBool__c, 'Notifications should be disabled');
        System.assertEquals(false, s.AutoCreateRequestFromTicketBool__c, 'Auto Create should be disabled');
        System.assertEquals(false, s.AutoSyncNetworkEntityBool__c, 'Auto Send should be disabled');
    }

    @isTest
    static void testSaveAiSettings() {
        Test.startTest();
        DeliveryHubSettingsController.saveAiSettings(false, true, false);
        Test.stopTest();

        Delivery_Hub_Settings__c s = Delivery_Hub_Settings__c.getOrgDefaults();
        System.assertEquals(false, s.AISuggestionsEnabledBool__c, 'AI Suggestions should be disabled');
        System.assertEquals(true, s.AutoGenerateDescriptionsBool__c, 'Auto Generate Descriptions should be enabled');
        System.assertEquals(false, s.AIEstimationEnabledBool__c, 'AI Estimation should be disabled');
    }

    @isTest
    static void testSaveOpenAISettings() {
        Test.startTest();
        DeliveryHubSettingsController.saveOpenAISettings('new-key', 'gpt-4o-mini', true);
        Test.stopTest();

        Delivery_Hub_Settings__c s = Delivery_Hub_Settings__c.getOrgDefaults();
        System.assertEquals('new-key', s.OpenAIApiKeyTxt__c, 'OpenAI API Key should be updated');
        System.assertEquals('gpt-4o-mini', s.OpenAIModelTxt__c, 'OpenAI Model should be updated');
        System.assertEquals(true, s.OpenAiApiTestedBool__c, 'OpenAI API should be marked as tested');
    }

    @isTest
    static void testSaveJiraSettings() {
        Test.startTest();
        DeliveryHubSettingsController.saveJiraSettings(
            'https://myjira.com',
            'user@jira.com',
            'new-token',
            'XYZ',
            true
        );
        Test.stopTest();

        Delivery_Hub_Settings__c s = Delivery_Hub_Settings__c.getOrgDefaults();
        System.assertEquals('https://myjira.com', s.JIRAInstanceUrl__c, 'JIRA URL should be updated');
        System.assertEquals('user@jira.com', s.JIRAUsernameTxt__c, 'JIRA Username should be updated');
        System.assertEquals('new-token', s.JIRAApiTokenTxt__c, 'JIRA API Token should be updated');
        System.assertEquals('XYZ', s.JIRAProjectKeyTxt__c, 'JIRA Project Key should be updated');
        System.assertEquals(true, s.JIraApiTestedBool__c, 'JIRA API should be marked as tested');
    }

    @isTest
    static void testSaveJiraEnabledState() {
        Test.startTest();
        DeliveryHubSettingsController.saveJiraEnabledState(false);
        Test.stopTest();

        Delivery_Hub_Settings__c s = Delivery_Hub_Settings__c.getOrgDefaults();
        System.assertEquals(false, s.JIRAEnabledBool__c, 'JIRA should be disabled');
    }

    @isTest
    static void testTestOpenAIConnectionMock() {
        Test.setMock(HttpCalloutMock.class, new MockOpenAIResponse());
        
        Test.startTest();
        String result = DeliveryHubSettingsController.testOpenAIConnection('test-api-key');
        Test.stopTest();

        System.assertNotEquals(null, result, 'Result should not be null');
    }

    @isTest
    static void testTestJiraConnectionMock() {
        Test.setMock(HttpCalloutMock.class, new MockJiraResponse());
        
        Test.startTest();
        String result = DeliveryHubSettingsController.testJiraConnection(
            'https://example.atlassian.net', 'user@example.com', 'token', 'ABC'
        );
        Test.stopTest();

        System.assertNotEquals(null, result, 'Result should not be null');
    }

    // ----------------- MOCK CLASSES -----------------
    
    /** @description Mock response for OpenAI */
    public class MockOpenAIResponse implements HttpCalloutMock {
        /** * @description Responds to HTTP request
         * @param req The request
         * @return HTTPResponse
         */
        public HTTPResponse respond(HTTPRequest req) {
            HttpResponse res = new HttpResponse();
            res.setStatusCode(200);
            res.setBody('{"id":"chatcmpl-123"}');
            return res;
        }
    }

    /** @description Mock response for JIRA */
    public class MockJiraResponse implements HttpCalloutMock {
        /** * @description Responds to HTTP request
         * @param req The request
         * @return HTTPResponse
         */
        public HTTPResponse respond(HTTPRequest req) {
            HttpResponse res = new HttpResponse();
            res.setStatusCode(200);
            res.setBody('{"key": "ABC"}');
            return res;
        }
    }
}